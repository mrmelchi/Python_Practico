<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Mario R. Melchiori">
        <link rel="canonical" href="https://mrmelchi.github.io/Python_Practico/06_Generators/03_Producers_consumers/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>03_Producers_consumers - Python Practico</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Python Practico</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#63-problemas-y-flujos-de-trabajo-de-productores-y-consumidores" class="nav-link">6.3 Problemas y flujos de trabajo de productores y consumidores</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#problemas-de-productor-consumidor" class="nav-link">Problemas de productor-consumidor</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#tuberias-de-generadores" class="nav-link">Tuberias de generadores</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#ejercicios" class="nav-link">Ejercicios</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#discusion" class="nav-link">Discusión</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><a href="../../Contents/">Contenido</a> | <a href="../02_Customizing_iteration/">Anterior (6.2 Personalización de la iteración)</a> | <a href="../04_More_generators/">Próximo (6.4 Expresiones generadoras)</a></p>
<h1 id="63-problemas-y-flujos-de-trabajo-de-productores-y-consumidores">6.3 Problemas y flujos de trabajo de productores y consumidores</h1>
<p>Los generadores son una herramienta útil para configurar varios tipos de problemas de productor/consumidor y las tuberías de flujo de datos. Esta sección trata sobre eso.</p>
<h2 id="problemas-de-productor-consumidor">Problemas de productor-consumidor</h2>
<p>Los generadores están estrechamente relacionados con varias formas de problemas de <em>productor-consumidor</em>.</p>
<pre><code class="language-python"># Productor
def follow(f):
    ...
    while True:
        ...
        yield line        # Produce el valor en `line` a continuación
        ...

# Consumidor
for line in follow(f):    # Consume el valor de `yield` arriba
    ...
</code></pre>
<p><code>yield</code> produce valores que <code>for</code> consume.</p>
<h2 id="tuberias-de-generadores">Tuberias de generadores</h2>
<p>Puede utilizar este aspecto de los generadores para configurar tuberías de procesamiento (como las tuberías de Unix).</p>
<p><em>productor</em> =&gt; <em>procesamiento</em> =&gt; <em>procesamiento</em> =&gt; <em>consumidor</em></p>
<p>Las tuberías de procesamiento tienen un productor de datos inicial, un conjunto de etapas de procesamiento intermedias y un consumidor final.</p>
<p><strong>productor</strong> =&gt; <em>procesamiento</em> =&gt; <em>procesamiento</em> =&gt; <em>consumidor</em></p>
<pre><code class="language-python">def productor():
    ...
    yield item
    ...
</code></pre>
<p>El productor es normalmente un generador. Aunque también podría ser una lista de alguna otra secuencia. <code>yield</code> introduce datos en la tubería.</p>
<p><em>productor</em> =&gt; <em>procesamiento</em> =&gt; <em>procesamiento</em> =&gt; <strong>consumidor</strong></p>
<pre><code class="language-python">def consumidor(s):
    for item in s:
        ...
</code></pre>
<p>El consumidor es un bucle <code>for</code>. Obtiene elementos y hace algo con ellos.</p>
<p><em>productor</em> =&gt; <strong>procesamiento</strong> =&gt; <strong>procesamiento</strong> =&gt; <em>consumidor</em></p>
<pre><code class="language-python">def procesamiento(s):
    for item in s:
        ...
        yield newitem
...
</code></pre>
<p>Las etapas de procesamiento intermedias consumen y producen elementos simultáneamente. Pueden modificar el flujo de datos. También pueden filtrar (descartando elementos).</p>
<p><em>productor</em> =&gt; <em>procesamiento</em> =&gt; <em>procesamiento</em> =&gt; <em>consumer</em></p>
<pre><code class="language-python">def productor():
    ...
    yield item # produce el elemento que recibe de `procesamiento`
    ...

def procesamiento(s):
    for item in s: # Proviene del `productor`
        ...
        yield newitem # produce un nuevo elemento
        ...

def consumidor(s):
    for item in s: # Proviene del `procesamiento`
        ...
</code></pre>
<p>Código para configurar la canalización</p>
<pre><code class="language-python">a = productor()
b = procesamiento(a)
c = consumidor(b)
</code></pre>
<p>Notarás que los datos fluyen de manera incremental a través de las diferentes funciones.</p>
<h2 id="ejercicios">Ejercicios</h2>
<p>Para este ejercicio, el programa <code>stocksim.py</code> debe seguir ejecutándose en segundo plano. Vas a utilizar la función <code>follow()</code> que escribiste en el ejercicio anterior.</p>
<h3 id="ejercicio-68-configuracion-de-una-tuberia-simple">Ejercicio 6.8: Configuración de una tubería simple</h3>
<p>Veamos la idea de la tubería en acción. Escriba la siguiente función:</p>
<pre><code class="language-python">&gt;&gt;&gt; def filematch(lines, substr):
...     for line in lines:
...         if substr in line:
...             yield line
... 

&gt;&gt;&gt;
</code></pre>
<p>Esta función es casi exactamente la misma que el primer ejemplo de generador del ejercicio anterior, excepto que ya no abre un archivo, sino que simplemente opera sobre una secuencia de líneas que se le proporciona como argumento. Ahora, pruebe esto:</p>
<pre><code>&gt;&gt;&gt; from follow import follow
&gt;&gt;&gt; lines = follow('Data/stocklog.csv')
&gt;&gt;&gt; ibm = filematch(lines, 'IBM')
&gt;&gt;&gt; for line in ibm:
        print(line)

... espere la salida ...
</code></pre>
<p>Puede que la salida tarde un poco en aparecer, pero con el tiempo debería ver algunas líneas que contienen datos de IBM.</p>
<h3 id="ejercicio-69-configuracion-de-una-secuencia-de-comandos-mas-compleja">Ejercicio 6.9: Configuración de una secuencia de comandos más compleja</h3>
<p>Lleve la idea de la secuencia de comandos un poco más allá realizando más acciones.</p>
<pre><code class="language-python">&gt;&gt;&gt; from follow import follow
&gt;&gt;&gt; import csv
&gt;&gt;&gt; lines = follow('Data/stocklog.csv')
&gt;&gt;&gt; rows = csv.reader(lines)
&gt;&gt;&gt; for row in rows:
        print(row)

['BA', '98.35', '6/11/2007', '09:41.07', '0.16', '98.25', '98.35', '98.31', '158148']
['AA', '39.63', '6/11/2007', '09:41.07', '-0.03', '39.67', '39.63', '39.31', '270224']
['XOM', '82.45', '6/11/2007', '09:41.07', '-0.23', '82.68', '82.64', '82.41', '748062']
['PG', '62.95', '6/11/2007', '09:41.08', '-0.12', '62.80', '62.97', '62.61', '454327']
</code></pre>
<p>Bueno, eso es interesante. Lo que estás viendo aquí es que la salida de la función <code>follow()</code> se ha canalizado a la función <code>csv.reader()</code> y ahora estamos obteniendo una secuencia de filas divididas.</p>
<h3 id="ejercicio-610-creacion-de-mas-componentes-de-tuberia">Ejercicio 6.10: Creación de más componentes de tubería</h3>
<p>Extendamos toda la idea a una canalización más grande. En un archivo separado <code>ticker.py</code>, comience por crear una función que lea un archivo CSV como lo hizo anteriormente:</p>
<pre><code class="language-python"># ticker.py

from follow import follow
import csv

def parse_stock_data(lines):
    rows = csv.reader(lines)
    return rows

if __name__ == '__main__':
    lines = follow('Data/stocklog.csv')
    rows = parse_stock_data(lines)
    for row in rows:
        print(row)
</code></pre>
<p>Escriba una nueva función que seleccione columnas específicas:</p>
<pre><code class="language-python"># ticker.py
...
def select_columns(rows, indices):
    for row in rows:
        yield [row[index] for index in indices]
...
def parse_stock_data(lines):
    rows = csv.reader(lines)
    rows = select_columns(rows, [0, 1, 4])
    return rows
</code></pre>
<p>Ejecute su programa nuevamente. Debería ver la salida acotada de esta manera:</p>
<pre><code>['BA', '98.35', '0.16']
['AA', '39.63', '-0.03']
['XOM', '82.45', '-0.23']
['PG', '62.95', '-0.12']
...
</code></pre>
<p>Escriba funciones generadoras que conviertan tipos de datos y creen diccionarios. Por ejemplo:</p>
<pre><code class="language-python"># ticker.py
...

def convert_types(rows, types):
    for row in rows:
        yield [func(val) for func, val in zip(types, row)]

def make_dicts(rows, headers):
    for row in rows:
        yield dict(zip(headers, row))
...
def parse_stock_data(lines):
    rows = csv.reader(lines)
    rows = select_columns(rows, [0, 1, 4])
    rows = convert_types(rows, [str, float, float])
    rows = make_dicts(rows, ['name', 'price', 'change'])
    return rows
...
</code></pre>
<p>Ejecute su programa nuevamente. Ahora debería aparecer un flujo de diccionarios como este:</p>
<pre><code>{ 'name':'BA', 'price':98.35, 'change':0.16 }
{ 'name':'AA', 'price':39.63, 'change':-0.03 }
{ 'name':'XOM', 'price':82.45, 'change': -0.23 }
{ 'name':'PG', 'price':62.95, 'change':-0.12 }
...
</code></pre>
<h3 id="ejercicio-611-filtrado-de-datos">Ejercicio 6.11: Filtrado de datos</h3>
<p>Escribe una función que filtre datos. Por ejemplo:</p>
<pre><code class="language-python"># ticker.py
...

def filter_symbols(rows, names):
    for row in rows:
        if row['name'] in names:
            yield row
</code></pre>
<p>Use esto para filtrar acciones y seleccionar solo las que están en su cartera:</p>
<pre><code class="language-python">import report
portfolio = report.read_portfolio('Data/portfolio.csv')
rows = parse_stock_data(follow('Data/stocklog.csv'))
rows = filter_symbols(rows, portfolio)
for row in rows:
    print(row)
</code></pre>
<h3 id="ejercicio-612-poniendolo-todo-junto">Ejercicio 6.12: Poniéndolo todo junto</h3>
<p>En el programa <code>ticker.py</code>, escriba una función <code>ticker(portfile, logfile, fmt)</code> que cree un ticker de acciones en tiempo real a partir de una cartera, un archivo de registro y un formato de tabla determinados. Por ejemplo::</p>
<pre><code class="language-python">&gt;&gt;&gt; from ticker import ticker
&gt;&gt;&gt; ticker('Data/portfolio.csv', 'Data/stocklog.csv', 'txt')
      Name      Price     Change
---------- ---------- ----------
        GE      37.14      -0.18
      MSFT      29.96      -0.09
       CAT      78.03      -0.49
        AA      39.34      -0.32
...

&gt;&gt;&gt; ticker('Data/portfolio.csv', 'Data/stocklog.csv', 'csv')
Name,Price,Change
IBM,102.79,-0.28
CAT,78.04,-0.48
AA,39.35,-0.31
CAT,78.05,-0.47
...
</code></pre>
<h2 id="discusion">Discusión</h2>
<p>Algunas lecciones aprendidas: Puede crear varias funciones generadoras y encadenarlas para realizar un procesamiento que involucre flujos de datos. Además, puede crear funciones que empaqueten una serie de etapas de flujos de datos en una única llamada a la función (por ejemplo, la función <code>parse_stock_data()</code>).</p>
<p><a href="../../Contents/">Contenido</a> | <a href="../02_Customizing_iteration/">Anterior (6.2 Personalización de la iteración)</a> | <a href="../04_More_generators/">Próximo (6.4 Expresiones generadoras)</a></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
