
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Mario R. Melchiori">
      
      
        <link rel="canonical" href="https://mrmelchi.github.io/Python_Practico/06_Generators/03_Producers_consumers/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>03_Producers_consumers - Python Practico</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a40c8224.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#63-problemas-y-flujos-de-trabajo-de-productores-y-consumidores" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Python Practico" class="md-header__button md-logo" aria-label="Python Practico" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Python Practico
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              03_Producers_consumers
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Python Practico" class="md-nav__button md-logo" aria-label="Python Practico" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Python Practico
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problemas-de-productor-consumidor" class="md-nav__link">
    <span class="md-ellipsis">
      Problemas de productor-consumidor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tuberias-de-generadores" class="md-nav__link">
    <span class="md-ellipsis">
      Tuberias de generadores
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejercicios" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicios
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ejercicios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ejercicio-68-configuracion-de-una-tuberia-simple" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicio 6.8: Configuración de una tubería simple
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejercicio-69-configuracion-de-una-secuencia-de-comandos-mas-compleja" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicio 6.9: Configuración de una secuencia de comandos más compleja
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejercicio-610-creacion-de-mas-componentes-de-tuberia" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicio 6.10: Creación de más componentes de tubería
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejercicio-611-filtrado-de-datos" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicio 6.11: Filtrado de datos
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejercicio-612-poniendolo-todo-junto" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicio 6.12: Poniéndolo todo junto
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#discusion" class="md-nav__link">
    <span class="md-ellipsis">
      Discusión
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p><a href="../../Contents/">Contenido</a> | <a href="../02_Customizing_iteration/">Anterior (6.2 Personalización de la iteración)</a> | <a href="../04_More_generators/">Próximo (6.4 Expresiones generadoras)</a></p>
<h1 id="63-problemas-y-flujos-de-trabajo-de-productores-y-consumidores">6.3 Problemas y flujos de trabajo de productores y consumidores</h1>
<p>Los generadores son una herramienta útil para configurar varios tipos de problemas de productor/consumidor y las tuberías de flujo de datos. Esta sección trata sobre eso.</p>
<h2 id="problemas-de-productor-consumidor">Problemas de productor-consumidor</h2>
<p>Los generadores están estrechamente relacionados con varias formas de problemas de <em>productor-consumidor</em>.</p>
<pre><code class="language-python"># Productor
def follow(f):
    ...
    while True:
        ...
        yield line        # Produce el valor en `line` a continuación
        ...

# Consumidor
for line in follow(f):    # Consume el valor de `yield` arriba
    ...
</code></pre>
<p><code>yield</code> produce valores que <code>for</code> consume.</p>
<h2 id="tuberias-de-generadores">Tuberias de generadores</h2>
<p>Puede utilizar este aspecto de los generadores para configurar tuberías de procesamiento (como las tuberías de Unix).</p>
<p><em>productor</em> =&gt; <em>procesamiento</em> =&gt; <em>procesamiento</em> =&gt; <em>consumidor</em></p>
<p>Las tuberías de procesamiento tienen un productor de datos inicial, un conjunto de etapas de procesamiento intermedias y un consumidor final.</p>
<p><strong>productor</strong> =&gt; <em>procesamiento</em> =&gt; <em>procesamiento</em> =&gt; <em>consumidor</em></p>
<pre><code class="language-python">def productor():
    ...
    yield item
    ...
</code></pre>
<p>El productor es normalmente un generador. Aunque también podría ser una lista de alguna otra secuencia. <code>yield</code> introduce datos en la tubería.</p>
<p><em>productor</em> =&gt; <em>procesamiento</em> =&gt; <em>procesamiento</em> =&gt; <strong>consumidor</strong></p>
<pre><code class="language-python">def consumidor(s):
    for item in s:
        ...
</code></pre>
<p>El consumidor es un bucle <code>for</code>. Obtiene elementos y hace algo con ellos.</p>
<p><em>productor</em> =&gt; <strong>procesamiento</strong> =&gt; <strong>procesamiento</strong> =&gt; <em>consumidor</em></p>
<pre><code class="language-python">def procesamiento(s):
    for item in s:
        ...
        yield newitem
...
</code></pre>
<p>Las etapas de procesamiento intermedias consumen y producen elementos simultáneamente. Pueden modificar el flujo de datos. También pueden filtrar (descartando elementos).</p>
<p><em>productor</em> =&gt; <em>procesamiento</em> =&gt; <em>procesamiento</em> =&gt; <em>consumer</em></p>
<pre><code class="language-python">def productor():
    ...
    yield item # produce el elemento que recibe de `procesamiento`
    ...

def procesamiento(s):
    for item in s: # Proviene del `productor`
        ...
        yield newitem # produce un nuevo elemento
        ...

def consumidor(s):
    for item in s: # Proviene del `procesamiento`
        ...
</code></pre>
<p>Código para configurar la canalización</p>
<pre><code class="language-python">a = productor()
b = procesamiento(a)
c = consumidor(b)
</code></pre>
<p>Notarás que los datos fluyen de manera incremental a través de las diferentes funciones.</p>
<h2 id="ejercicios">Ejercicios</h2>
<p>Para este ejercicio, el programa <code>stocksim.py</code> debe seguir ejecutándose en segundo plano. Vas a utilizar la función <code>follow()</code> que escribiste en el ejercicio anterior.</p>
<h3 id="ejercicio-68-configuracion-de-una-tuberia-simple">Ejercicio 6.8: Configuración de una tubería simple</h3>
<p>Veamos la idea de la tubería en acción. Escriba la siguiente función:</p>
<pre><code class="language-python">&gt;&gt;&gt; def filematch(lines, substr):
...     for line in lines:
...         if substr in line:
...             yield line
... 

&gt;&gt;&gt;
</code></pre>
<p>Esta función es casi exactamente la misma que el primer ejemplo de generador del ejercicio anterior, excepto que ya no abre un archivo, sino que simplemente opera sobre una secuencia de líneas que se le proporciona como argumento. Ahora, pruebe esto:</p>
<pre><code>&gt;&gt;&gt; from follow import follow
&gt;&gt;&gt; lines = follow('Data/stocklog.csv')
&gt;&gt;&gt; ibm = filematch(lines, 'IBM')
&gt;&gt;&gt; for line in ibm:
        print(line)

... espere la salida ...
</code></pre>
<p>Puede que la salida tarde un poco en aparecer, pero con el tiempo debería ver algunas líneas que contienen datos de IBM.</p>
<h3 id="ejercicio-69-configuracion-de-una-secuencia-de-comandos-mas-compleja">Ejercicio 6.9: Configuración de una secuencia de comandos más compleja</h3>
<p>Lleve la idea de la secuencia de comandos un poco más allá realizando más acciones.</p>
<pre><code class="language-python">&gt;&gt;&gt; from follow import follow
&gt;&gt;&gt; import csv
&gt;&gt;&gt; lines = follow('Data/stocklog.csv')
&gt;&gt;&gt; rows = csv.reader(lines)
&gt;&gt;&gt; for row in rows:
        print(row)

['BA', '98.35', '6/11/2007', '09:41.07', '0.16', '98.25', '98.35', '98.31', '158148']
['AA', '39.63', '6/11/2007', '09:41.07', '-0.03', '39.67', '39.63', '39.31', '270224']
['XOM', '82.45', '6/11/2007', '09:41.07', '-0.23', '82.68', '82.64', '82.41', '748062']
['PG', '62.95', '6/11/2007', '09:41.08', '-0.12', '62.80', '62.97', '62.61', '454327']
</code></pre>
<p>Bueno, eso es interesante. Lo que estás viendo aquí es que la salida de la función <code>follow()</code> se ha canalizado a la función <code>csv.reader()</code> y ahora estamos obteniendo una secuencia de filas divididas.</p>
<h3 id="ejercicio-610-creacion-de-mas-componentes-de-tuberia">Ejercicio 6.10: Creación de más componentes de tubería</h3>
<p>Extendamos toda la idea a una canalización más grande. En un archivo separado <code>ticker.py</code>, comience por crear una función que lea un archivo CSV como lo hizo anteriormente:</p>
<pre><code class="language-python"># ticker.py

from follow import follow
import csv

def parse_stock_data(lines):
    rows = csv.reader(lines)
    return rows

if __name__ == '__main__':
    lines = follow('Data/stocklog.csv')
    rows = parse_stock_data(lines)
    for row in rows:
        print(row)
</code></pre>
<p>Escriba una nueva función que seleccione columnas específicas:</p>
<pre><code class="language-python"># ticker.py
...
def select_columns(rows, indices):
    for row in rows:
        yield [row[index] for index in indices]
...
def parse_stock_data(lines):
    rows = csv.reader(lines)
    rows = select_columns(rows, [0, 1, 4])
    return rows
</code></pre>
<p>Ejecute su programa nuevamente. Debería ver la salida acotada de esta manera:</p>
<pre><code>['BA', '98.35', '0.16']
['AA', '39.63', '-0.03']
['XOM', '82.45', '-0.23']
['PG', '62.95', '-0.12']
...
</code></pre>
<p>Escriba funciones generadoras que conviertan tipos de datos y creen diccionarios. Por ejemplo:</p>
<pre><code class="language-python"># ticker.py
...

def convert_types(rows, types):
    for row in rows:
        yield [func(val) for func, val in zip(types, row)]

def make_dicts(rows, headers):
    for row in rows:
        yield dict(zip(headers, row))
...
def parse_stock_data(lines):
    rows = csv.reader(lines)
    rows = select_columns(rows, [0, 1, 4])
    rows = convert_types(rows, [str, float, float])
    rows = make_dicts(rows, ['name', 'price', 'change'])
    return rows
...
</code></pre>
<p>Ejecute su programa nuevamente. Ahora debería aparecer un flujo de diccionarios como este:</p>
<pre><code>{ 'name':'BA', 'price':98.35, 'change':0.16 }
{ 'name':'AA', 'price':39.63, 'change':-0.03 }
{ 'name':'XOM', 'price':82.45, 'change': -0.23 }
{ 'name':'PG', 'price':62.95, 'change':-0.12 }
...
</code></pre>
<h3 id="ejercicio-611-filtrado-de-datos">Ejercicio 6.11: Filtrado de datos</h3>
<p>Escribe una función que filtre datos. Por ejemplo:</p>
<pre><code class="language-python"># ticker.py
...

def filter_symbols(rows, names):
    for row in rows:
        if row['name'] in names:
            yield row
</code></pre>
<p>Use esto para filtrar acciones y seleccionar solo las que están en su cartera:</p>
<pre><code class="language-python">import report
portfolio = report.read_portfolio('Data/portfolio.csv')
rows = parse_stock_data(follow('Data/stocklog.csv'))
rows = filter_symbols(rows, portfolio)
for row in rows:
    print(row)
</code></pre>
<h3 id="ejercicio-612-poniendolo-todo-junto">Ejercicio 6.12: Poniéndolo todo junto</h3>
<p>En el programa <code>ticker.py</code>, escriba una función <code>ticker(portfile, logfile, fmt)</code> que cree un ticker de acciones en tiempo real a partir de una cartera, un archivo de registro y un formato de tabla determinados. Por ejemplo::</p>
<pre><code class="language-python">&gt;&gt;&gt; from ticker import ticker
&gt;&gt;&gt; ticker('Data/portfolio.csv', 'Data/stocklog.csv', 'txt')
      Name      Price     Change
---------- ---------- ----------
        GE      37.14      -0.18
      MSFT      29.96      -0.09
       CAT      78.03      -0.49
        AA      39.34      -0.32
...

&gt;&gt;&gt; ticker('Data/portfolio.csv', 'Data/stocklog.csv', 'csv')
Name,Price,Change
IBM,102.79,-0.28
CAT,78.04,-0.48
AA,39.35,-0.31
CAT,78.05,-0.47
...
</code></pre>
<h2 id="discusion">Discusión</h2>
<p>Algunas lecciones aprendidas: Puede crear varias funciones generadoras y encadenarlas para realizar un procesamiento que involucre flujos de datos. Además, puede crear funciones que empaqueten una serie de etapas de flujos de datos en una única llamada a la función (por ejemplo, la función <code>parse_stock_data()</code>).</p>
<p><a href="../../Contents/">Contenido</a> | <a href="../02_Customizing_iteration/">Anterior (6.2 Personalización de la iteración)</a> | <a href="../04_More_generators/">Próximo (6.4 Expresiones generadoras)</a></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  </body>
</html>